language: cpp
os:
  - osx
  - linux
dist: trusty
sudo: required
before_install:
  - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then
    brew update;
    brew install pyenv; eval "$(pyenv init -)"; pyenv install 2.7.6; pyenv global 2.7.6; pyenv rehash; pip install cpp-coveralls; pyenv rehash;
    brew install lcov; 
    brew tap yijunyu/fast; brew install srcml;
    brew install protobuf;version=3.3.0 && brew install flatbuffers;
    brew install antlr; brew install antlr4-cpp-runtime;
    git clone --recursive https://github.com/srcml/srcSlice; cd srcSlice/srcSAX; mkdir build; cd build; cmake ..; make; sudo cp bin/libsrcsax.* /usr/local/lib/; cd ../../..;
    fi
  - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then
    sudo apt-get install apt-transport-https;
    sudo su -c "echo deb https://yijunyu.github.io/ubuntu ./ >> /etc/apt/sources.list";
    sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y;
    sudo apt-get update;
    sudo apt-get install gcc-4.9 g++-4.9;
    sudo ln -s -v -f $(which g++-4.9) /usr/bin/g++; 
    sudo ln -s -v -f $(which gcc-4.9) /usr/bin/gcc; 
    sudo apt-get install -y --force-yes srcml;
    sudo apt-get install libarchive13;
    sudo apt-get install libxml2;
    sudo apt-get install mono;
    wget https://github.com/google/flatbuffers/archive/v1.6.0.tar.gz; tar xvfz v1.6.0.tar.gz; cd flatbuffers-1.6.0; cmake .; make; sudo make install; cd -;
    wget https://github.com/google/protobuf/releases/download/v3.3.0/protobuf-cpp-3.3.0.tar.gz; tar xvfz protobuf-cpp-3.3.0.tar.gz; cd protobuf-3.3.0; ./configure; make; sudo make install; cd -;
    git clone --recursive https://github.com/srcml/srcSlice; cd srcSlice/srcSAX; mkdir build; cd build; cmake ..; make; sudo cp bin/libsrcsax.* /usr/local/lib/; cd ../../..;
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib;
    sudo apt-get install lcov;
    pip install --user cpp-coveralls;
    sudo apt-get install antlr4;
    wget http://www.antlr.org/download/antlr4-cpp-runtime-4.7-source.zip; mkdir antlr4-cpp-runtime; cd antlr4-cpp-runtime; unzip ../antlr4-cpp-runtime-4.7-source.zip; cmake .; make; sudo make install; cd ..;
    git clone https://github.com/antlr/antlr4; cd antlr4; mvn package; sudo cp ./tool/target/antlr4-4.7.1-SNAPSHOT.jar /usr/share/java/antlr4.jar; sudo cp ./runtime/Java/lib/org.abego.treelayout.core.jar /usr/share/java/; sudo cp ./runtime/Java/target/antlr4-runtime-4.7.1-SNAPSHOT.jar /usr/share/java/antlr4-runtime.jar; cd ..;
    fi
script:
  - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
  - cd test && ./test.sh
after_success:
  - coveralls --exclude lib --exclude test --gcov-options '\-lp'
